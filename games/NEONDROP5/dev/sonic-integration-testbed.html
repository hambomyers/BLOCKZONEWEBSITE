<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Labs Integration Testbed - AAA Development Tool</title>
      <!-- Sonic Labs Web3 Dependencies -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script src="../../core-systems/sonic-config.js"></script>
    
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff88;
            padding: 20px;
            margin: 0;
        }
        
        .testbed-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .test-section {
            border: 2px solid #00ff88;
            background: rgba(0, 255, 136, 0.05);
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .sonic-header {
            text-align: center;
            grid-column: 1 / -1;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        
        .test-button {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5);
        }
        
        .danger-btn {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
        }
        
        .output {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #00ff88;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .success { color: #00ff88; }
        .error { color: #ff4757; }
        .warning { color: #ffa726; }
        .info { color: #42a5f5; }
        
        .network-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .connected { background: #00ff88; }
        .disconnected { background: #ff4757; }
        .pending { background: #ffa726; }
    </style>
</head>
<body>
    <div class="testbed-container">
        <h1 class="sonic-header">üöÄ Sonic Labs Integration Testbed</h1>
        
        <!-- Network Status Panel -->
        <div class="test-section">
            <h2>üåê Sonic Network Status</h2>
            <div class="network-status">
                <div class="status-indicator disconnected" id="network-indicator"></div>
                <span id="network-status">Disconnected</span>
            </div>
            <button class="test-button" onclick="connectSonicNetwork()">Connect to Sonic Labs</button>
            <button class="test-button" onclick="checkNetworkHealth()">Network Health Check</button>
            <button class="test-button danger-btn" onclick="switchToMainnet()">Switch to Mainnet</button>
            <div id="networkOutput" class="output"></div>
        </div>

        <!-- Smart Contract Testing -->
        <div class="test-section">
            <h2>üìã Smart Contract Integration</h2>
            <button class="test-button" onclick="deployTestContracts()">Deploy Test Contracts</button>
            <button class="test-button" onclick="testScoreSubmission()">Test Score Submission</button>
            <button class="test-button" onclick="testRewardDistribution()">Test QUARTERS Distribution</button>
            <button class="test-button" onclick="verifyGameProofs()">Verify Game Proofs</button>
            <div id="contractOutput" class="output"></div>
        </div>

        <!-- Game Engine Integration -->
        <div class="test-section">
            <h2>üéÆ Game Engine ‚Üí Blockchain Bridge</h2>
            <button class="test-button" onclick="testGameEngineIntegration()">Test Game Engine Bridge</button>
            <button class="test-button" onclick="simulateCompetitiveGame()">Simulate Competitive Game</button>
            <button class="test-button" onclick="testAntiCheatProofs()">Test Anti-Cheat Proofs</button>
            <button class="test-button" onclick="benchmarkPerformance()">Performance Benchmark</button>
            <div id="gameEngineOutput" class="output"></div>
        </div>

        <!-- Wallet & Identity Testing -->
        <div class="test-section">
            <h2>üë§ Player Identity & Wallet</h2>
            <button class="test-button" onclick="testWalletOnboarding()">Test Wallet Creation</button>
            <button class="test-button" onclick="testIdentityMigration()">Test Anonymous ‚Üí Wallet</button>
            <button class="test-button" onclick="testNFTIntegration()">Test NFT Benefits</button>
            <button class="test-button" onclick="stressTestTransactions()">Stress Test Transactions</button>
            <div id="walletOutput" class="output"></div>
        </div>

        <!-- Tournament System -->
        <div class="test-section">
            <h2>üèÜ Tournament & Rewards</h2>
            <button class="test-button" onclick="testTournamentEntry()">Test Tournament Entry</button>
            <button class="test-button" onclick="simulateRewardDistribution()">Simulate Reward Distribution</button>
            <button class="test-button" onclick="testLeaderboardSync()">Test Leaderboard Sync</button>
            <button class="test-button" onclick="validateRewardEconomics()">Validate Economics</button>
            <div id="tournamentOutput" class="output"></div>
        </div>

        <!-- Advanced Analytics -->
        <div class="test-section">
            <h2>üìä Analytics & Monitoring</h2>
            <button class="test-button" onclick="generateAnalyticsReport()">Generate Analytics Report</button>
            <button class="test-button" onclick="testRealTimeMetrics()">Test Real-time Metrics</button>
            <button class="test-button" onclick="auditSecurityVectors()">Security Audit</button>
            <button class="test-button" onclick="exportTestResults()">Export Test Results</button>
            <div id="analyticsOutput" class="output"></div>
        </div>
    </div>

    <script type="module">
        import { GameEngine } from './game-engine.js';
        import { Config } from './config.js';
        import { ScoringSystem } from './scoring.js';
        import { BlockchainBridge } from '../../core-systems/core/blockchain.js';
        import { WalletOnboarding } from '../../core-systems/core/wallet-onboarding.js';

        // Global test environment
        window.testConfig = new Config();
        window.testBlockchain = new BlockchainBridge(window.testConfig);
        window.testGameEngine = null;
        window.testResults = {
            network: [],
            contracts: [],
            gameEngine: [],
            wallet: [],
            tournament: [],
            analytics: []
        };

        await window.testConfig.load();

        // === SONIC NETWORK TESTING ===
        window.connectSonicNetwork = async function() {
            const output = document.getElementById('networkOutput');
            const indicator = document.getElementById('network-indicator');
            const status = document.getElementById('network-status');
            
            output.innerHTML = '<span class="info">üîÑ Connecting to Sonic Labs Network...</span>\n';
            indicator.className = 'status-indicator pending';
            status.textContent = 'Connecting...';
            
            try {
                // Test Sonic Labs specific connection
                await window.testBlockchain.connect();
                await window.testBlockchain.verifyNetwork('sonic-testnet');
                
                const networkInfo = await window.testBlockchain.provider.getNetwork();
                const blockNumber = await window.testBlockchain.provider.getBlockNumber();
                
                output.innerHTML += `<span class="success">‚úÖ Connected to Sonic Labs!</span>\n`;
                output.innerHTML += `Network: ${networkInfo.name} (Chain ID: ${networkInfo.chainId})\n`;
                output.innerHTML += `Current Block: ${blockNumber}\n`;
                output.innerHTML += `RPC Latency: ${await measureRPCLatency()}ms\n`;
                
                indicator.className = 'status-indicator connected';
                status.textContent = 'Connected to Sonic Labs';
                
                window.testResults.network.push({
                    test: 'Sonic Connection',
                    status: 'PASS',
                    details: { networkInfo, blockNumber }
                });
                
            } catch (error) {
                output.innerHTML += `<span class="error">‚ùå Connection failed: ${error.message}</span>\n`;
                indicator.className = 'status-indicator disconnected';
                status.textContent = 'Connection Failed';
                
                window.testResults.network.push({
                    test: 'Sonic Connection',
                    status: 'FAIL',
                    error: error.message
                });
            }
        };

        window.testGameEngineIntegration = async function() {
            const output = document.getElementById('gameEngineOutput');
            output.innerHTML = '<span class="info">üéÆ Testing Game Engine ‚Üí Blockchain Integration...</span>\n';
            
            try {
                // Initialize test game engine with blockchain
                window.testGameEngine = new GameEngine(
                    window.testConfig,
                    null, // No audio for testing
                    window.testBlockchain
                );
                
                output.innerHTML += '<span class="success">‚úÖ Game engine initialized with blockchain</span>\n';
                
                // Test game session tracking
                window.testGameEngine.startGame('competitive');
                output.innerHTML += '<span class="success">‚úÖ Competitive game session started</span>\n';
                
                // Simulate some game actions
                const testActions = [
                    { type: 'MOVE', dx: 1, dy: 0 },
                    { type: 'ROTATE', direction: 1 },
                    { type: 'HARD_DROP' }
                ];
                
                for (const action of testActions) {
                    window.testGameEngine.handleInput(action);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                output.innerHTML += '<span class="success">‚úÖ Game actions recorded to blockchain</span>\n';
                
                // Test proof generation
                if (window.testBlockchain.isTracking()) {
                    const mockFinalState = {
                        score: 1500,
                        lines: 15,
                        level: 3,
                        pieces: 25
                    };
                    
                    const proof = window.testBlockchain.generateProof(mockFinalState);
                    output.innerHTML += '<span class="success">‚úÖ Cryptographic proof generated</span>\n';
                    output.innerHTML += `Proof hash: ${proof.merkleRoot.slice(0, 10)}...\n`;
                    output.innerHTML += `Action count: ${proof.actionCount}\n`;
                }
                
                window.testResults.gameEngine.push({
                    test: 'Game Engine Integration',
                    status: 'PASS',
                    details: 'Full integration working'
                });
                
            } catch (error) {
                output.innerHTML += `<span class="error">‚ùå Integration test failed: ${error.message}</span>\n`;
                window.testResults.gameEngine.push({
                    test: 'Game Engine Integration',
                    status: 'FAIL',
                    error: error.message
                });
            }
        };

        window.testScoreSubmission = async function() {
            const output = document.getElementById('contractOutput');
            output.innerHTML = '<span class="info">üìã Testing Score Submission to Sonic Contracts...</span>\n';
            
            try {
                if (!window.testBlockchain.isConnected()) {
                    throw new Error('Not connected to Sonic Network');
                }
                
                // Generate test proof
                const testScore = 2500;
                const mockProof = {
                    seed: Date.now(),
                    finalScore: testScore,
                    endTime: Date.now(),
                    merkleRoot: '0x' + '1'.repeat(64), // Mock hash
                    actions: [],
                    metrics: {}
                };
                
                output.innerHTML += '<span class="info">üîÑ Submitting test score to Sonic contract...</span>\n';
                
                // Test score submission (would be actual transaction on mainnet)
                const result = await window.testBlockchain.submitScore(testScore, mockProof);
                
                output.innerHTML += '<span class="success">‚úÖ Score submitted successfully!</span>\n';
                output.innerHTML += `Transaction Hash: ${result.transactionHash}\n`;
                output.innerHTML += `Gas Used: ${result.gasUsed}\n`;
                output.innerHTML += `Block: ${result.blockNumber}\n`;
                
                window.testResults.contracts.push({
                    test: 'Score Submission',
                    status: 'PASS',
                    details: { score: testScore, txHash: result.transactionHash }
                });
                
            } catch (error) {
                output.innerHTML += `<span class="error">‚ùå Score submission failed: ${error.message}</span>\n`;
                window.testResults.contracts.push({
                    test: 'Score Submission',
                    status: 'FAIL',
                    error: error.message
                });
            }
        };

        // Utility functions
        async function measureRPCLatency() {
            const start = Date.now();
            await window.testBlockchain.provider.getBlockNumber();
            return Date.now() - start;
        }

        window.exportTestResults = function() {
            const results = {
                timestamp: new Date().toISOString(),
                environment: 'Sonic Labs Testnet',
                results: window.testResults
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], 
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sonic_integration_test_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            const output = document.getElementById('analyticsOutput');
            output.innerHTML = '<span class="success">‚úÖ Test results exported successfully!</span>\n';
        };

        // Additional test functions would go here...
        // (Placeholder functions for demonstration)
        window.checkNetworkHealth = () => console.log('Network health check');
        window.switchToMainnet = () => console.log('Switch to mainnet');
        window.deployTestContracts = () => console.log('Deploy test contracts');
        window.testRewardDistribution = () => console.log('Test reward distribution');
        window.verifyGameProofs = () => console.log('Verify game proofs');
        window.simulateCompetitiveGame = () => console.log('Simulate competitive game');
        window.testAntiCheatProofs = () => console.log('Test anti-cheat proofs');
        window.benchmarkPerformance = () => console.log('Benchmark performance');
        window.testWalletOnboarding = () => console.log('Test wallet onboarding');
        window.testIdentityMigration = () => console.log('Test identity migration');
        window.testNFTIntegration = () => console.log('Test NFT integration');
        window.stressTestTransactions = () => console.log('Stress test transactions');
        window.testTournamentEntry = () => console.log('Test tournament entry');
        window.simulateRewardDistribution = () => console.log('Simulate reward distribution');
        window.testLeaderboardSync = () => console.log('Test leaderboard sync');
        window.validateRewardEconomics = () => console.log('Validate economics');
        window.generateAnalyticsReport = () => console.log('Generate analytics report');
        window.testRealTimeMetrics = () => console.log('Test real-time metrics');
        window.auditSecurityVectors = () => console.log('Security audit');
    </script>
</body>
</html>
